---
import Layout from '../../layouts/Layout.astro';
import CardList from '../../components/CardList.astro';
import { getCollection } from 'astro:content';

const news = await getCollection('news', ({ data }) => !data.draft);
const sortedNews = news.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// CardList用にデータを変換
const items = sortedNews.map((item) => ({
  id: item.id,
  title: item.data.title,
  description: item.data.description,
  pubDate: item.data.pubDate,
  href: `/news/${item.id}`,
}));

const PER_PAGE = 20;
---

<Layout title="News | kouno.log">
  <h1>News</h1>
  <p>お知らせ一覧</p>

  <CardList items={items} />

  <div class="pagination">
    <button class="page-btn" id="prev-btn" disabled>&larr; Prev</button>
    <span class="page-info" id="page-info">1 / 1</span>
    <button class="page-btn" id="next-btn">Next &rarr;</button>
  </div>
</Layout>

<style>
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
  }

  .page-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .page-btn:hover:not(:disabled) {
    border-color: #999;
    background: #f5f5f5;
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .page-info {
    color: #666;
    font-size: 0.875rem;
  }
</style>

<script define:vars={{ PER_PAGE }}>
  const allItems = Array.from(document.querySelectorAll('.card-list li'));
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const pageInfo = document.getElementById('page-info');

  let currentPage = 1;

  function updateDisplay() {
    const totalPages = Math.ceil(allItems.length / PER_PAGE) || 1;

    const start = (currentPage - 1) * PER_PAGE;
    const end = start + PER_PAGE;

    allItems.forEach((item, index) => {
      if (index >= start && index < end) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });

    pageInfo.textContent = `${currentPage} / ${totalPages}`;
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
  }

  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updateDisplay();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  nextBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(allItems.length / PER_PAGE) || 1;
    if (currentPage < totalPages) {
      currentPage++;
      updateDisplay();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  updateDisplay();
</script>
